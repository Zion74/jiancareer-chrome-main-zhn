<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单通信测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .form-section {
            margin: 20px 0;
        }
        .form-field {
            margin: 10px 0;
        }
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-field input, .form-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chrome扩展通信测试</h1>
        
        <div class="test-section">
            <h3>环境检测</h3>
            <div id="env-status" class="result info">检测中...</div>
            <button class="test-button" onclick="checkEnvironment()">重新检测</button>
        </div>

        <div class="test-section">
            <h3>基础通信测试</h3>
            <button class="test-button" onclick="testPing()">Ping测试</button>
            <button class="test-button" onclick="testDetect()">检测测试</button>
            <button class="test-button" onclick="testExtensionPing()">扩展Ping</button>
            <div id="comm-results"></div>
        </div>

        <div class="test-section">
            <h3>表单测试</h3>
            <div class="form-section">
                <div class="form-field">
                    <label for="name">姓名:</label>
                    <input type="text" id="name" name="name" placeholder="请输入姓名">
                </div>
                <div class="form-field">
                    <label for="email">邮箱:</label>
                    <input type="email" id="email" name="email" placeholder="请输入邮箱">
                </div>
                <div class="form-field">
                    <label for="phone">电话:</label>
                    <input type="tel" id="phone" name="phone" placeholder="请输入电话">
                </div>
                <div class="form-field">
                    <label for="company">公司:</label>
                    <input type="text" id="company" name="company" placeholder="请输入公司">
                </div>
            </div>
            <button class="test-button" onclick="testAutofill()">测试自动填写</button>
            <button class="test-button" onclick="clearForm()">清空表单</button>
        </div>

        <div class="test-section">
            <h3>日志输出</h3>
            <div id="log"></div>
            <button class="test-button" onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        let messageId = 0;
        let pendingMessages = new Map();

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function showResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        function checkEnvironment() {
            const statusDiv = document.getElementById('env-status');
            
            // 检查是否在Chrome扩展环境中
            if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                statusDiv.className = 'result success';
                statusDiv.textContent = '✅ Chrome扩展环境检测成功';
                log('Chrome扩展环境检测成功', 'success');
            } else {
                statusDiv.className = 'result error';
                statusDiv.textContent = '❌ Chrome扩展环境未检测到';
                log('Chrome扩展环境未检测到', 'error');
            }

            // 检查Content Script是否注入
            if (window.jiancareerContentScript) {
                log('Content Script已注入', 'success');
            } else {
                log('Content Script未检测到', 'error');
            }
        }

        function testPing() {
            log('开始Ping测试...');
            const message = {
                type: 'JC_PING',
                id: ++messageId,
                timestamp: Date.now()
            };

            pendingMessages.set(message.id, {
                type: 'ping',
                startTime: Date.now()
            });

            window.postMessage(message, '*');
            log(`发送Ping消息: ${JSON.stringify(message)}`);

            // 5秒超时
            setTimeout(() => {
                if (pendingMessages.has(message.id)) {
                    pendingMessages.delete(message.id);
                    showResult('comm-results', 'Ping测试超时', 'error');
                    log('Ping测试超时', 'error');
                }
            }, 5000);
        }

        function testDetect() {
            log('开始检测测试...');
            const message = {
                type: 'JC_DETECT',
                id: ++messageId,
                timestamp: Date.now()
            };

            pendingMessages.set(message.id, {
                type: 'detect',
                startTime: Date.now()
            });

            window.postMessage(message, '*');
            log(`发送检测消息: ${JSON.stringify(message)}`);

            setTimeout(() => {
                if (pendingMessages.has(message.id)) {
                    pendingMessages.delete(message.id);
                    showResult('comm-results', '检测测试超时', 'error');
                    log('检测测试超时', 'error');
                }
            }, 5000);
        }

        function testExtensionPing() {
            log('开始扩展Ping测试...');
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                showResult('comm-results', '扩展环境不可用', 'error');
                log('扩展环境不可用', 'error');
                return;
            }

            try {
                chrome.runtime.sendMessage({
                    type: 'PING',
                    timestamp: Date.now()
                }, (response) => {
                    if (chrome.runtime.lastError) {
                        showResult('comm-results', `扩展Ping失败: ${chrome.runtime.lastError.message}`, 'error');
                        log(`扩展Ping失败: ${chrome.runtime.lastError.message}`, 'error');
                    } else {
                        showResult('comm-results', '扩展Ping成功', 'success');
                        log(`扩展Ping成功: ${JSON.stringify(response)}`, 'success');
                    }
                });
            } catch (error) {
                showResult('comm-results', `扩展Ping异常: ${error.message}`, 'error');
                log(`扩展Ping异常: ${error.message}`, 'error');
            }
        }

        function testAutofill() {
            log('开始自动填写测试...');
            const message = {
                type: 'JC_AUTOFILL',
                id: ++messageId,
                timestamp: Date.now(),
                data: {
                    name: '张三',
                    email: 'zhangsan@example.com',
                    phone: '13800138000',
                    company: '测试公司'
                }
            };

            pendingMessages.set(message.id, {
                type: 'autofill',
                startTime: Date.now()
            });

            window.postMessage(message, '*');
            log(`发送自动填写消息: ${JSON.stringify(message)}`);

            setTimeout(() => {
                if (pendingMessages.has(message.id)) {
                    pendingMessages.delete(message.id);
                    showResult('comm-results', '自动填写测试超时', 'error');
                    log('自动填写测试超时', 'error');
                }
            }, 5000);
        }

        function clearForm() {
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('company').value = '';
            log('表单已清空');
        }

        // 监听来自Content Script的消息
        window.addEventListener('message', function(event) {
            if (event.source !== window) return;

            const message = event.data;
            if (!message || !message.type) return;

            log(`收到消息: ${JSON.stringify(message)}`);

            if (message.id && pendingMessages.has(message.id)) {
                const pending = pendingMessages.get(message.id);
                const duration = Date.now() - pending.startTime;
                pendingMessages.delete(message.id);

                if (message.type === 'JC_PONG') {
                    showResult('comm-results', `Ping测试成功 (${duration}ms)`, 'success');
                    log(`Ping测试成功，耗时: ${duration}ms`, 'success');
                } else if (message.type === 'JC_DETECT_RESPONSE') {
                    showResult('comm-results', `检测测试成功 (${duration}ms)`, 'success');
                    log(`检测测试成功，耗时: ${duration}ms，结果: ${JSON.stringify(message.data)}`, 'success');
                } else if (message.type === 'JC_AUTOFILL_RESPONSE') {
                    showResult('comm-results', `自动填写测试成功 (${duration}ms)`, 'success');
                    log(`自动填写测试成功，耗时: ${duration}ms`, 'success');
                }
            }
        });

        // 页面加载完成后检测环境
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成');
            setTimeout(checkEnvironment, 1000);
        });

        // 监听扩展安装状态
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                log(`收到扩展消息: ${JSON.stringify(message)}`);
                sendResponse({success: true, timestamp: Date.now()});
            });
        }
    </script>
</body>
</html>